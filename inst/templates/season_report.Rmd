---
title: "Harvest Information Program Season Summary Report"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output: 
  html_document:
    toc: true
    toc_depth: 3
    number_sections: true
    theme: cerulean
params:
  comp_path:
    value: x
  year:
    value: x
---

```{r libs, include = FALSE}
library(tidyverse)
```

```{r import, include = FALSE}

season_data <- read_hip(params$comp_path)

tidied_data <- tidy(season_data)

# Remove original data to improve memory use
rm(season_data)

fixed_data <- fixDuplicates(tidied_data)

proofed_data <- proof(fixed_data, year = params$year)

corrected_data <- correct(proofed_data, year = params$year)

```

# Introduction

This is a summary report of the `r params$year` Season of Harvest Information Program (HIP) data. This year, **`r nrow(proofed_data)`** records were submitted from **`r proofed_data %>% select(dl_state) %>% distinct %>% nrow()`** states.

# Visualization of errors

To get a general idea of what the data look like, first we visualize the errors as plots.

## Error plots

### Duplicates

**Before fixDuplicates**

```{r b_fd, echo = FALSE}
findDuplicates(tidied_data)
```

**After fixDuplicates**

```{r a_fd, echo = FALSE}
findDuplicates(fixed_data)
```

### Check strata

```{r stratacheck, echo = FALSE}
strataCheck(fixed_data)
```

### Repeated values

**Horizontal**

```{r h_validate, echo = FALSE}
validate(fixed_data, type = "horizontal")
```

**Vertical**

```{r v_validate, echo = FALSE}
validate(fixed_data, type = "vertical")
```

```{r data_sweep, include = FALSE}

# Remove tidied and fixed data to improve memory use
rm(tidied_data)
rm(fixed_data)

```

### Errors by field

**Before correction**

```{r erpf, echo = FALSE}
errorPlot_fields(proofed_data, specify = params$year)
```

**After correction**

```{r erpf_c, echo = FALSE}
errorPlot_fields(corrected_data, specify = params$year)
```

### Errors by state

**Before correction**

```{r erps, echo = FALSE}
errorPlot_states(proofed_data)
```

**After correction**

```{r erps_c, echo = FALSE}
errorPlot_states(corrected_data)
```

### Errors by download

**Before correction**

```{r erpdl, echo = FALSE}
errorPlot_dl(proofed_data)
```

**After correction**

```{r erpdl_c, echo = FALSE}
errorPlot_dl(corrected_data)
```

## Out-of-state hunters

```{r oosh, echo = FALSE}
outOfStateHunters(proofed_data)
```

## Youth hunters

```{r yh, echo = FALSE}
youthHunters(proofed_data, year = params$year)
```

# Explore errors

Let's take a closer look at common errors and issues within this season's HIP data.

## High error counts

**Q: What were the most common errors, and what values caused them?**

Tibble of most common errors...

```{r et, echo = FALSE}
et <- errorTable(proofed_data, loc = "none") %>% arrange(desc(error_count))

et
```

Values associated with error in **`r et$error[1]`**

```{r pe_1, echo = FALSE}
err1 <- pullErrors(proofed_data, error = et$error[1])

if(length(err1) > 20){
  err1[1:20]
  } else {
  err1
    }
```

Values associated with error in **`r et$error[2]`**

```{r pe_2, echo = FALSE}
err2 <- pullErrors(proofed_data, error = et$error[2])

if(length(err2) > 20){
  err2[1:20]
  } else {
  err2
    }
```

Values associated with error in **`r et$error[3]`**

```{r pe_3, echo = FALSE}
err3 <- pullErrors(proofed_data, error = et$error[3])

if(length(err3) > 20){
  err3[1:20]
  } else {
  err3
    } 
```

## High error proportions

**Q: What states and fields had a proportion of error that exceeded an acceptable threshold?**

**States** with more than 1% error

```{r rfs, echo = FALSE}
redFlags(proofed_data, type = "state", threshold = 0.1)
```

**Fields** with more than 1% error

```{r rff, echo = FALSE}
redFlags(proofed_data, type = "field", threshold = 0.1)
```
